<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AR Drifting Car - Racing Game Style</title>
  
  <!-- Load A-Frame and AR.js from a reliable source -->
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.min.js"></script>
  
  <script>
    window.onload = function() {
      console.log("Page loaded. Click anywhere to start AR.");
      document.getElementById('loading-message').style.display = 'block';
      
      // Check if this page was loaded via QR code scan
      const isQRCodeScan = checkIfQRCodeScan();
      
      if (isQRCodeScan) {
        startARExperience();
      } else {
        document.getElementById('click-message').style.display = 'block';
        document.addEventListener('click', function() {
          startARExperience();
        }, { once: true });
      }
    };
    
    function checkIfQRCodeScan() {
      // Add a URL parameter to detect when the page is loaded via QR scan
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.has('qr');
    }
    
    function startARExperience() {
      console.log("Starting AR session");
      document.getElementById('loading-message').style.display = 'none';
      document.getElementById('click-message').style.display = 'none';
      document.querySelector('a-scene').setAttribute('arjs', 'sourceType: webcam;');
      
      // Request device motion and orientation permissions
      if (typeof DeviceOrientationEvent !== 'undefined' && 
          typeof DeviceOrientationEvent.requestPermission === 'function') {
        DeviceOrientationEvent.requestPermission()
          .then(response => {
            if (response == 'granted') {
              console.log('Device orientation permission granted');
              initGyroscopeControl();
            }
          })
          .catch(console.error);
      } else {
        // For non-iOS devices or iOS < 13
        console.log('Device orientation permission not needed or not available');
        initGyroscopeControl();
      }
    }
    
    function initGyroscopeControl() {
      const camera = document.querySelector('a-entity[camera]');
      let baseRotation = { x: 0, y: 0, z: 0 };
      let initialOrientationRecorded = false;
      
      window.addEventListener('deviceorientation', function(event) {
        if (!initialOrientationRecorded) {
          // Record initial orientation as base
          baseRotation.x = event.beta || 0;
          baseRotation.y = event.gamma || 0;
          baseRotation.z = event.alpha || 0;
          initialOrientationRecorded = true;
          document.getElementById('gyro-status').textContent = 'Active';
        }
        
        // Calculate the compensated rotation to keep level perspective
        const compensatedRotation = camera.getAttribute('rotation') || {x: 0, y: 0, z: 0};
        compensatedRotation.z = -(event.gamma || 0) + baseRotation.y;
        
        // Limit the compensation to avoid extreme values
        compensatedRotation.z = Math.max(-45, Math.min(45, compensatedRotation.z));
        
        // Apply the compensated rotation
        camera.setAttribute('rotation', compensatedRotation);
      });
    }
    
    AFRAME.registerComponent('marker-listener', {
      init: function () {
        let marker = this.el;
        let button = document.getElementById("start-drift-button");
        marker.addEventListener('markerFound', function() {
          button.style.display = "block";
          document.getElementById('debug-message').textContent = "Marker detected!";
          document.getElementById('marker-status').textContent = "Visible";
        });
        marker.addEventListener('markerLost', function() {
          button.style.display = "none";
          document.getElementById('debug-message').textContent = "Waiting for marker...";
          document.getElementById('marker-status').textContent = "Hidden";
        });
      }
    });
    
    function startDrift() {
      let car = document.querySelector("[drift-entry]");
      car.setAttribute('animation', {
        property: 'position',
        to: '0 0 0',
        dur: 1500,
        easing: 'easeOutQuad',
        from: '-2 0 -1'
      });
      car.setAttribute('animation__rotation', {
        property: 'rotation',
        to: '0 0 0',
        dur: 1500,
        easing: 'easeOutQuad',
        from: '0 45 0'
      });
      setTimeout(() => {
        car.setAttribute('showroom-animation', '');
      }, 1600);
      document.getElementById("start-drift-button").style.display = "none";
    }
    
    AFRAME.registerComponent('showroom-animation', {
      tick: function (time, timeDelta) {
        let angle = Math.sin(time / 500) * 5; // Slight left-right sway
        let bounce = Math.sin(time / 300) * 0.02; // Slight engine vibration
        this.el.setAttribute('rotation', `0 ${angle} 0`);
        this.el.setAttribute('position', `0 ${bounce} 0`);
      }
    });
    
    AFRAME.registerComponent('moving-road', {
      tick: function (time, timeDelta) {
        let road = this.el;
        let offset = (time / 1000) % 1;
        road.setAttribute('material', 'offset', `0 ${offset}`);
      }
    });
  </script>
  
  <style>
    #loading-message, #click-message, #start-drift-button {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 20px;
      border-radius: 10px;
      font-family: Arial, sans-serif;
      text-align: center;
      z-index: 9999;
    }
    #loading-message, #start-drift-button { display: none; }
    
    #debug-info {
      position: fixed;
      bottom: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px;
      border-radius: 5px;
      font-family: monospace;
      font-size: 12px;
      z-index: 1000;
    }
    
    .debug-heading {
      font-weight: bold;
      margin-top: 5px;
    }
    
    #qr-instructions {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px;
      border-radius: 5px;
      font-family: Arial, sans-serif;
      font-size: 14px;
      z-index: 1000;
      max-width: 250px;
    }
  </style>
</head>
<body style="margin: 0; overflow: hidden;">
  <!-- Click message -->
  <div id="click-message">Click anywhere to start the AR experience<br><small>Camera and motion sensor access required</small></div>
  
  <!-- Loading message -->
  <div id="loading-message">
    <h2>Starting AR Experience</h2>
    <p>Please allow camera access when prompted</p>
  </div>
  
  <!-- Start Drift Button -->
  <button id="start-drift-button" onclick="startDrift()">Start Drift</button>
  
  <!-- QR code instructions -->
  <div id="qr-instructions">
    Point your camera at the QR code to see the JDM car. Tilt your phone naturally - the gyroscope will keep the car level.
  </div>
  
  <!-- A-Frame scene -->
  <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;">
    <!-- Image-based marker instead of barcode -->
    <a-marker type="pattern" url="pattern-qr.patt" marker-listener>
      <a-entity gltf-model="./assets/scene.glb" scale="0.5 0.5 0.5" position="-2 0 -1" rotation="0 45 0" drift-entry></a-entity>
      <a-plane position="0 -0.02 0" rotation="-90 0 0" width="2" height="5" material="color: #333; repeat: 1 5;" moving-road></a-plane>
    </a-marker>
    <a-entity camera></a-entity>
  </a-scene>
  
  <!-- Debug and Controls -->
  <div id="debug-info">
    <p>AR Racing Drift</p>
    <p id="debug-message">Waiting for marker...</p>
    <div class="debug-heading">Marker:</div>
    <p>Status: <span id="marker-status">Hidden</span></p>
    <div class="debug-heading">Gyroscope:</div>
    <p id="gyro-status">Initializing...</p>
  </div>
</body>
</html>
