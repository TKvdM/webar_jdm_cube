<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AR Drifting Car - Racing Game Style</title>
  
  <!-- Load A-Frame and AR.js from a reliable source -->
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.min.js"></script>
  
  <script>
    window.onload = function() {
      console.log("Page loaded. Click anywhere to start AR.");
      document.getElementById('loading-message').style.display = 'block';
      
      document.addEventListener('click', function() {
        console.log("Click detected - Starting AR session");
        document.getElementById('loading-message').style.display = 'none';
        document.getElementById('click-message').style.display = 'none';
        document.querySelector('a-scene').setAttribute('arjs', 'sourceType: webcam;');
      }, { once: true });
    };
    
    AFRAME.registerComponent('marker-listener', {
      init: function () {
        let marker = this.el;
        let button = document.getElementById("start-drift-button");
        marker.addEventListener('markerFound', function() {
          button.style.display = "block";
        });
        marker.addEventListener('markerLost', function() {
          button.style.display = "none";
        });
      }
    });
    
    function startDrift() {
      let car = document.querySelector("[drift-entry]");
      car.setAttribute('animation', {
        property: 'position',
        to: '0 0 0',
        dur: 1500,
        easing: 'easeOutQuad',
        from: '-2 0 -1'
      });
      car.setAttribute('animation__rotation', {
        property: 'rotation',
        to: '0 0 0',
        dur: 1500,
        easing: 'easeOutQuad',
        from: '0 45 0'
      });
      setTimeout(() => {
        car.setAttribute('showroom-animation', '');
      }, 1600);
      document.getElementById("start-drift-button").style.display = "none";
    }
    
    AFRAME.registerComponent('showroom-animation', {
      tick: function (time, timeDelta) {
        let angle = Math.sin(time / 500) * 5; // Slight left-right sway
        let bounce = Math.sin(time / 300) * 0.02; // Slight engine vibration
        this.el.setAttribute('rotation', `0 ${angle} 0`);
        this.el.setAttribute('position', `0 ${bounce} 0`);
      }
    });
    
    AFRAME.registerComponent('moving-road', {
      tick: function (time, timeDelta) {
        let road = this.el;
        let offset = (time / 1000) % 1;
        road.setAttribute('material', 'offset', `0 ${offset}`);
      }
    });
  </script>
  
  <style>
    #loading-message, #click-message, #start-drift-button {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 20px;
      border-radius: 10px;
      font-family: Arial, sans-serif;
      text-align: center;
      z-index: 9999;
    }
    #loading-message, #start-drift-button { display: none; }
  </style>
</head>
<body style="margin: 0; overflow: hidden;">
  <!-- Click message -->
  <div id="click-message">Click anywhere to start the AR experience<br><small>Camera and motion sensor access required</small></div>
  
  <!-- Loading message -->
  <div id="loading-message">
    <h2>Starting AR Experience</h2>
    <p>Please allow camera access when prompted</p>
  </div>
  
  <!-- Start Drift Button -->
  <button id="start-drift-button" onclick="startDrift()">Start Drift</button>
  
  <!-- A-Frame  -->
  <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;">
    <a-marker preset="hiro" marker-listener>
      <a-entity gltf-model="/assets/scene.glb" scale="0.5 0.5 0.5" drift-entry showroom-animation></a-entity>
      <a-plane position="0 -0.02 0" rotation="-90 0 0" width="2" height="5" material="color: #333; repeat: 1 5;" moving-road></a-plane>
    </a-marker>
    <a-entity camera></a-entity>
  </a-scene>
  
  <!-- Debug and Controls -->
  <div id="debug-info">
    <p>AR Racing Drift</p>
    <p id="debug-message">Waiting for marker...</p>
    <div class="debug-heading">Marker:</div>
    <p>Status: <span id="marker-status">Hidden</span></p>
  </div>
</body>
</html>
