<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WebAR Car Showcase</title>
    <script src="https://cdn.jsdelivr.net/gh/aframevr/aframe@1.3.0/dist/aframe-master.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: fixed;
        }
        
        .arjs-loader {
            position: fixed;
            z-index: 1000;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.8);
        }
        
        .arjs-loader-spinner {
            z-index: 1001;
            width: 30px;
            height: 30px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #555;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .ar-controls {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 10px;
            z-index: 999;
        }
        
        .ar-button {
            padding: 12px 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: bold;
        }
        
        #debug-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            z-index: 1000;
            max-width: 80%;
            overflow: auto;
            max-height: 30%;
        }
        
        #instruction-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            font-family: sans-serif;
            text-align: center;
            z-index: 2000;
            display: none;
        }
        
        .progress-container {
            width: 100%;
            background-color: #333;
            margin-top: 10px;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .progress-bar {
            width: 0%;
            height: 10px;
            background-color: #4CAF50;
            border-radius: 5px;
            transition: width 0.3s;
        }

        .a-enter-vr {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="arjs-loader">
        <div>
            <div class="arjs-loader-spinner"></div>
            <p style="color: white; text-align: center; margin-top: 10px;">Loading WebAR Experience...</p>
        </div>
    </div>

    <div id="debug-panel">Initializing...</div>
    
    <div id="instruction-panel">
        <h2>Find a flat surface</h2>
        <p>Move your device around to find a flat surface where the road can be placed</p>
        <div class="progress-container">
            <div class="progress-bar" id="scan-progress"></div>
        </div>
    </div>

    <!-- Samsung S23 optimized AR Scene -->
    <a-scene 
        vr-mode-ui="enabled: false"
        renderer="logarithmicDepthBuffer: true; colorManagement: true; sortObjects: true; physicallyCorrectLights: true;"
        embedded
        arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3; sourceWidth: 1080; sourceHeight: 1920; displayWidth: window.innerWidth; displayHeight: window.innerHeight;">
        
        <!-- HIRO Marker Content -->
        <a-marker id="hiro-marker" preset="hiro" raycaster="objects: .clickable" emitevents="true" cursor="fuse: false; rayOrigin: mouse;">
            <a-entity 
                id="hiro-message" 
                position="0 0.5 0" 
                rotation="-90 0 0" 
                text="value: HIRO marker detected!\nNow looking for a flat surface...; color: white; align: center; width: 2; wrapCount: 20">
            </a-entity>
        </a-marker>

        <!-- Surface Content (Initially Hidden) -->
        <a-entity id="surface-content" visible="false">
            <!-- Road -->
            <a-plane id="road" width="4" height="10" rotation="-90 0 0" position="0 0 0" color="#555555">
                <a-plane width="0.1" height="1" color="white" position="0 2 0.01" 
                      animation="property: position.y; from: 5; to: -5; dur: 2000; easing: linear; loop: true"></a-plane>
                <a-plane width="0.1" height="1" color="white" position="0 -1 0.01" 
                      animation="property: position.y; from: 2; to: -8; dur: 2000; easing: linear; loop: true"></a-plane>
                <a-plane width="0.1" height="1" color="white" position="0 -4 0.01" 
                      animation="property: position.y; from: -1; to: -11; dur: 2000; easing: linear; loop: true"></a-plane>
            </a-plane>

            <!-- Car entity -->
            <a-entity position="-1.5 0.25 0" rotation="0 90 0" scale="1 1 1">
                <a-box id="temp-car" color="red" width="0.5" height="0.3" depth="1" visible="true"
                     animation="property: position.x; from: -2; to: 2; dur: 4000; easing: linear; loop: true"></a-box>

                <!-- Actual car model with animation -->
                <a-entity 
                    id="car-model" 
                    gltf-model="Untitled.glb"
                    animation-mixer="clip: *; loop: repeat"
                    visible="false"
                    animation="property: position.x; from: -2; to: 2; dur: 4000; easing: linear; loop: true">
                </a-entity>
            </a-entity>

            <!-- Lighting -->
            <a-light type="ambient" color="#BBB" intensity="0.7"></a-light>
            <a-light type="directional" color="#FFF" intensity="1" position="-1 1 2"></a-light>
        </a-entity>

        <!-- Camera with mouse/touch cursor -->
        <a-entity camera look-controls wasd-controls="enabled: false"></a-entity>
    </a-scene>

    <!-- Control buttons -->
    <div class="ar-controls">
        <button class="ar-button" id="toggle-model">Toggle Model</button>
        <button class="ar-button" id="try-load">Reload Model</button>
        <button class="ar-button" id="place-surface" style="display: none;">Place Road Here</button>
    </div>

    <script>
        window.onload = function() {
            const debugPanel = document.getElementById('debug-panel');
            const instructionPanel = document.getElementById('instruction-panel');
            const scanProgress = document.getElementById('scan-progress');
            const toggleButton = document.getElementById('toggle-model');
            const tryLoadButton = document.getElementById('try-load');
            const placeSurfaceButton = document.getElementById('place-surface');
            const loader = document.querySelector('.arjs-loader');
            
            // App state
            let appState = 'initializing';
            let scanTimer = null;
            let scanDuration = 0;
            
            function updateDebug(message) {
                const timestamp = new Date().toLocaleTimeString();
                debugPanel.innerHTML += `<br>${timestamp}: ${message}`;
                debugPanel.scrollTop = debugPanel.scrollHeight;
                console.log(message);
            }
            
            // Initialize with debug info
            updateDebug(`Screen dimensions: ${window.innerWidth}x${window.innerHeight}`);
            updateDebug(`Device pixel ratio: ${window.devicePixelRatio}`);
            updateDebug(`User agent: ${navigator.userAgent}`);
            
            // Special config for Samsung devices
            if (navigator.userAgent.includes("Samsung") || navigator.userAgent.includes("SM-")) {
                updateDebug("Samsung device detected, applying optimizations");
                // Specific Samsung optimizations could be added here
            }
            
            // Handle scene loaded
            document.querySelector('a-scene').addEventListener('loaded', function () {
                updateDebug('âœ… AR Scene loaded');
                loader.style.display = 'none';
                
                // Set Samsung-specific camera parameters
                const camera = document.querySelector('[camera]');
                camera.setAttribute('look-controls', 'touchEnabled: true; magicWindowTrackingEnabled: true');
                
                updateDebug('Waiting for HIRO marker...');
            });
            
            // Handle marker detection
            document.querySelector('#hiro-marker').addEventListener('markerFound', function() {
                updateDebug('âœ… HIRO marker found');
                
                if (appState === 'initializing') {
                    appState = 'marker-detected';
                    
                    // After a short delay, switch to surface scanning mode
                    setTimeout(() => {
                        startSurfaceScanning();
                    }, 2000);
                }
            });
            
            document.querySelector('#hiro-marker').addEventListener('markerLost', function() {
                updateDebug('âŒ HIRO marker lost');
                
                if (appState === 'marker-detected') {
                    // Reset if we lose the marker before finding a surface
                    appState = 'initializing';
                }
            });
            
            // Start surface scanning
            function startSurfaceScanning() {
                appState = 'surface-scanning';
                updateDebug('ðŸ” Looking for flat surface...');
                
                // Show user instructions
                instructionPanel.style.display = 'block';
                placeSurfaceButton.style.display = 'inline-block';
                
                // Simulate surface scanning progress
                scanDuration = 0;
                scanTimer = setInterval(() => {
                    scanDuration += 100;
                    let progress = Math.min(scanDuration / 3000 * 100, 100);
                    scanProgress.style.width = `${progress}%`;
                    
                    if (progress >= 100) {
                        clearInterval(scanTimer);
                        updateDebug('âœ… Flat surface detected! You can place the road now.');
                        instructionPanel.querySelector('h2').innerText = 'Surface Found!';
                        instructionPanel.querySelector('p').innerText = 'Press "Place Road Here" button to continue';
                    }
                }, 100);
            }
            
            // Handle model loading events
            const carModel = document.querySelector('#car-model');
            const tempCar = document.querySelector('#temp-car');
            
            carModel.addEventListener('model-loaded', function(evt) {
                updateDebug('âœ… Model loaded successfully!');
                tempCar.setAttribute('visible', 'false');
                carModel.setAttribute('visible', 'true');
                
                // Check for animations
                if (evt.detail && evt.detail.model && evt.detail.model.animations) {
                    updateDebug(`ðŸŽ¬ Animations found: ${evt.detail.model.animations.length}`);
                } else {
                    updateDebug('âŒ No animations found in model!');
                }
            });
            
            carModel.addEventListener('model-error', function(evt) {
                updateDebug('âŒ Error loading model: ' + (evt.detail ? evt.detail.message : 'Unknown error'));
                tempCar.setAttribute('visible', 'true');
            });
            
            // UI button handlers
            toggleButton.addEventListener('click', function() {
                const isModelVisible = carModel.getAttribute('visible') === 'true';
                updateDebug(`Toggling visibility: model=${!isModelVisible}, placeholder=${isModelVisible}`);
                carModel.setAttribute('visible', !isModelVisible);
                tempCar.setAttribute('visible', isModelVisible);
            });
            
            tryLoadButton.addEventListener('click', function() {
                updateDebug('Attempting to reload model...');
                const currentUrl = carModel.getAttribute('gltf-model');
                carModel.setAttribute('gltf-model', '');
                setTimeout(() => {
                    carModel.setAttribute('gltf-model', currentUrl);
                    updateDebug('Model reload attempted');
                }, 500);
            });
            
            placeSurfaceButton.addEventListener('click', function() {
                appState = 'placed';
                instructionPanel.style.display = 'none';
                
                // Hide HIRO marker content, show surface content
                document.querySelector('#hiro-marker').setAttribute('visible', 'false');
                const surfaceContent = document.querySelector('#surface-content');
                surfaceContent.setAttribute('visible', 'true');
                
                // Position surface content in front of camera
                const camera = document.querySelector('[camera]');
                const cameraPosition = camera.object3D.position;
                const cameraRotation = camera.object3D.rotation;
                
                // Create vector pointing forward from camera
                const forward = new THREE.Vector3(0, 0, -1);
                forward.applyQuaternion(camera.object3D.quaternion);
                forward.multiplyScalar(3); // 3 units in front
                
                // Set position
                surfaceContent.setAttribute('position', {
                    x: cameraPosition.x + forward.x,
                    y: 0, // On ground level
                    z: cameraPosition.z + forward.z
                });
                
                // Set rotation to face camera (but keep road flat)
                const angle = Math.atan2(forward.x, forward.z);
                surfaceContent.setAttribute('rotation', {x: 0, y: THREE.MathUtils.radToDeg(angle), z: 0});
                
                updateDebug('âœ… Road placed on surface!');
            });
            
            // Handle orientation changes
            window.addEventListener('orientationchange', function() {
                setTimeout(() => {
                    updateDebug(`Orientation changed: ${window.innerWidth}x${window.innerHeight}`);
                    // Force camera update to avoid distortion
                    const camera = document.querySelector('[camera]');
                    if (camera) {
                        camera.setAttribute('camera', 'active', false);
                        setTimeout(() => camera.setAttribute('camera', 'active', true), 100);
                    }
                }, 100);
            });
            
            // Fix for video rendering on some devices
            const video = document.querySelector('video');
            if (video) {
                video.setAttribute('playsinline', '');
                video.setAttribute('webkit-playsinline', '');
            }
        };
    </script>
</body>
</html>
