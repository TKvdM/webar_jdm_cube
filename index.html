<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>WebAR Car Showcase</title>
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            width: 100%;
            background: black;
        }

        /* Scene canvas + UI container */
        .a-canvas,
        #ui-container {
            position: absolute !important;
            top: 0;
            left: 0;
            width: 100% !important;
        }

        #debug-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-width: calc(100% - 20px);
            overflow: auto;
            max-height: 30%;
            pointer-events: auto;
            z-index: 1000;
        }

        .ar-controls {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 10px;
            pointer-events: auto;
            z-index: 1000;
        }

        .ar-button {
            padding: 12px 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            font-size: 16px;
            min-width: 120px;
        }

        #arjs-video {
            object-fit: cover !important;
        }
    </style>
</head>
<body>
    <a-scene embedded 
        arjs="sourceType: webcam; debugUIEnabled: false; deviceOrientation: true;
              cameraParametersUrl: camera_para.dat; maxDetectionRate: 60;"
        vr-mode-ui="enabled: false"
        renderer="antialias: true; alpha: true; precision: mediump;">
        
        <a-marker preset="hiro">
            <!-- Road -->
            <a-plane width="4" height="10" rotation="-90 0 0" position="0 0 0" color="#555555">
                <a-plane 
                    width="0.2" 
                    height="10" 
                    rotation="0 0 0" 
                    position="0 0 0.01" 
                    color="#FFFFFF">
                </a-plane>
            </a-plane>

            <!-- Car -->
            <a-entity position="0 0.5 0" rotation="0 180 0" scale="0.5 0.5 0.5">
                <a-box id="temp-car" color="red" width="1.5" height="0.8" depth="3" visible="true"></a-box>
                <a-entity id="car-model" gltf-model="car-1.glb" visible="false"></a-entity>
            </a-entity>

            <a-light type="ambient" color="#BBB" intensity="0.7"></a-light>
            <a-light type="directional" color="#FFF" intensity="1" position="-1 1 2"></a-light>
        </a-marker>

        <a-entity camera></a-entity>
    </a-scene>

    <!-- UI -->
    <div id="ui-container">
        <div id="debug-panel">Model status: Initializing...</div>
        <div class="ar-controls">
            <button class="ar-button" id="toggle-model">Toggle Model</button>
            <button class="ar-button" id="try-load">Reload Model</button>
        </div>
    </div>

    <script>
        function setFullHeight() {
            const height = window.innerHeight + 'px';
            document.body.style.height = height;
            document.querySelector('.a-canvas')?.style.setProperty('height', height, 'important');
            document.getElementById('ui-container')?.style.setProperty('height', height, 'important');
        }

        window.addEventListener('load', setFullHeight);
        window.addEventListener('resize', setFullHeight);
        window.addEventListener('orientationchange', () => {
            setTimeout(setFullHeight, 300);
        });

        document.addEventListener('DOMContentLoaded', function() {
            const debugPanel = document.getElementById('debug-panel');
            const carModel = document.getElementById('car-model');
            const tempCar = document.getElementById('temp-car');
            const toggleButton = document.getElementById('toggle-model');
            const tryLoadButton = document.getElementById('try-load');

            function updateDebug(message) {
                const timestamp = new Date().toLocaleTimeString();
                debugPanel.innerHTML += `<br>${timestamp}: ${message}`;
                debugPanel.scrollTop = debugPanel.scrollHeight;
                console.log(message);

                if (debugPanel.innerHTML.length > 5000) {
                    const lines = debugPanel.innerHTML.split('<br>');
                    if (lines.length > 20) {
                        debugPanel.innerHTML = lines.slice(-20).join('<br>');
                    }
                }
            }

            function checkCameraPermission() {
                navigator.mediaDevices.getUserMedia({video: true})
                    .then(stream => {
                        updateDebug('✅ Camera permission granted');
                        stream.getTracks().forEach(track => track.stop());
                    })
                    .catch(err => {
                        updateDebug('❌ Camera access error: ' + err.message);
                    });
            }

            function fixCameraOrientation() {
                const video = document.querySelector('#arjs-video');
                if (video) {
                    video.style.objectFit = 'cover';
                    updateDebug('Applied camera display fix');
                    if (/Android/i.test(navigator.userAgent)) {
                        video.style.transform = window.innerHeight > window.innerWidth ?
                            'rotate(-90deg)' : 'none';
                    }
                } else {
                    updateDebug('⚠️ Could not find AR.js video element');
                    setTimeout(fixCameraOrientation, 1000);
                }
            }

            function fixAndroidDisplay() {
                setTimeout(() => {
                    document.body.style.visibility = 'hidden';
                    document.body.offsetHeight;
                    document.body.style.visibility = 'visible';
                }, 300);

                document.getElementById('ui-container').style.zIndex = '1000';

                if (/Android/i.test(navigator.userAgent)) {
                    document.querySelectorAll('.ar-button').forEach(btn => {
                        btn.style.padding = '15px 25px';
                    });
                    updateDebug('Applied Android UI fixes');
                }
            }

            carModel.addEventListener('model-loaded', function() {
                updateDebug('✅ Model loaded successfully!');
                tempCar.setAttribute('visible', 'false');
                carModel.setAttribute('visible', 'true');
            });

            carModel.addEventListener('model-error', function(evt) {
                updateDebug('❌ Error loading model: ' + (evt.detail?.message || "Unknown error"));
                tempCar.setAttribute('visible', 'true');

                fetch('car-1.glb', {method: 'HEAD'})
                    .then(response => {
                        if (response.ok) {
                            updateDebug('✅ Model URL exists but may have CORS issues');
                        } else {
                            updateDebug(`❌ Model URL returned ${response.status}`);
                        }
                    })
                    .catch(error => {
                        updateDebug(`❌ Network error: ${error.message}`);
                    });
            });

            toggleButton.addEventListener('click', function() {
                const isModelVisible = carModel.getAttribute('visible') === 'true';
                updateDebug(`Toggling visibility: model=${!isModelVisible}, placeholder=${isModelVisible}`);
                carModel.setAttribute('visible', !isModelVisible);
                tempCar.setAttribute('visible', isModelVisible);
            });

            tryLoadButton.addEventListener('click', function() {
                updateDebug('Attempting to reload model...');
                const currentUrl = carModel.getAttribute('gltf-model');
                carModel.setAttribute('gltf-model', '');
                setTimeout(() => {
                    carModel.setAttribute('gltf-model', currentUrl);
                    updateDebug('Model reload attempted');
                }, 500);
            });

            const marker = document.querySelector('a-marker');
            marker.addEventListener('markerFound', () => updateDebug('✅ Marker found'));
            marker.addEventListener('markerLost', () => updateDebug('❌ Marker lost'));

            const scene = document.querySelector('a-scene');
            scene.addEventListener('loaded', function() {
                updateDebug('✅ Scene loaded');
                setTimeout(() => {
                    checkCameraPermission();
                    fixCameraOrientation();
                    fixAndroidDisplay();
                    setFullHeight();
                }, 1000);
            });
        });
    </script>
</body>
</html>
